#!/bin/bash

# kurbeScript - Kubernetes Cluster Setup Script
# Starts a Kubernetes cluster on the machine, verifies it's running,
# and retrieves available pods

set -e

echo "=========================================="
echo "Kubernetes Cluster Setup Script"
echo "=========================================="

# Check if minikube is installed
echo ""
echo "[1/4] Checking if Minikube is installed..."
if ! command -v minikube &> /dev/null; then
    echo "❌ Minikube is not installed."
    echo "Please install Minikube from: https://minikube.sigs.k8s.io/docs/start/"
    exit 1
fi
echo "✓ Minikube is installed"

# Check if kubectl is installed
echo ""
echo "[2/4] Checking if kubectl is installed..."
if ! command -v kubectl &> /dev/null; then
    echo "❌ kubectl is not installed."
    echo "Please install kubectl from: https://kubernetes.io/docs/tasks/tools/"
    exit 1
fi
echo "✓ kubectl is installed"

# Start Minikube cluster
echo ""
echo "[3/4] Starting Minikube cluster..."
minikube start --driver=docker 2>/dev/null || minikube start
echo "✓ Minikube cluster started"

# Verify cluster is running
echo ""
echo "[4/4] Verifying cluster status..."
kubectl cluster-info
echo ""

# Display cluster nodes
echo "=========================================="
echo "Cluster Nodes:"
echo "=========================================="
kubectl get nodes -o wide
echo ""

# Retrieve available pods
echo "=========================================="
echo "Available Pods (all namespaces):"
echo "=========================================="
kubectl get pods --all-namespaces -o wide
echo ""

# Display cluster components
echo "=========================================="
echo "Cluster Components Status:"
echo "=========================================="
kubectl get componentstatuses
echo ""

echo "✓ Kubernetes cluster setup completed successfully!"
echo ""
echo "Next steps:"
echo "1. Deploy your Django app: kubectl apply -f deployment.yaml"
echo "2. Check pod status: kubectl get pods"
echo "3. View pod logs: kubectl logs <pod-name>"
echo "4. Port forward to access the app: kubectl port-forward svc/django-service 8000:8000"
